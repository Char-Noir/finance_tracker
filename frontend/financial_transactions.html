<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Transactions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <header class="bg-primary text-white text-center py-3">
        <h1>Фінансовий рух</h1>
    </header>
    <div class="container mt-5">
        <!-- Фільтри -->
        <form id="filter-form" class="row g-3 mb-4">
            <div class="col-md-3">
                <label for="start-date" class="form-label">Start Date:</label>
                <input type="date" id="start-date" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="end-date" class="form-label">End Date:</label>
                <input type="date" id="end-date" class="form-control">
            </div>
            <div class="col-md-2">
                <label for="source" class="form-label">Source:</label>
                <select id="source" class="form-select">
                    <option value="">All</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="category" class="form-label">Category:</label>
                <select id="category" class="form-select">
                    <option value="">All</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="bank" class="form-label">Bank:</label>
                <select id="bank" class="form-select">
                    <option value="">All</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="min-amount" class="form-label">Min Amount:</label>
                <input type="number" id="min-amount" class="form-control" placeholder="Min" step="0.01">
            </div>
            <div class="col-md-3">
                <label for="max-amount" class="form-label">Max Amount:</label>
                <input type="number" id="max-amount" class="form-control" placeholder="Max" step="0.01">
            </div>
            <div class="col-md-12 text-end">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
            </div>
        </form>
        <div style = "display: flex;"> 
            <div class="col-md-1">
                <a href="../" class="btn btn-primary">Назад</a>
            </div>
            <div class="col-md-1">
                <a href="/upload_transactions.html" class="btn btn-primary">Завантажити</a>
            </div>
        </div>
       

        <!-- Таблиця -->
        <table class="table table-bordered text-center">
            <thead>
                <tr>
                    <th data-sort="date" class="sortable">Date</th>
                    <th data-sort="source" class="sortable">Source</th>
                    <th data-sort="category" class="sortable">Category</th>
                    <th data-sort="bank" class="sortable">Bank</th>
                    <th data-sort="amount" class="sortable">Amount (UAH)</th>
                </tr>
            </thead>
            <tbody id="transactions-table-body">
                <!-- Дані будуть додані динамічно -->
            </tbody>
        </table>

        <!-- Пагінація -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Пагінація буде динамічною -->
            </ul>
        </nav>
    </div>

    <script>
        const apiUrl = "http://127.0.0.1:8000/financial-transactions";
        const sourcesUrl = "http://127.0.0.1:8000/transaction-sources/sh";
        const categoriesUrl = "http://127.0.0.1:8000/transaction-source-categories/sh";
        const banksUrl = "http://127.0.0.1:8000/data-sources/sh";
        let currentPage = 1;
        let sortField = "date";
        let sortOrder = "asc";

        async function fetchTransactions(page = 1) {
            const startDate = document.getElementById("start-date").value;
            const endDate = document.getElementById("end-date").value;
            const source = document.getElementById("source").value;
            const category = document.getElementById("category").value;
            const bank = document.getElementById("bank").value;
            const minAmount = document.getElementById("min-amount").value;
            const maxAmount = document.getElementById("max-amount").value;

            const params = new URLSearchParams({
                page,
                sort: sortField,
                order: sortOrder,
                start_date: startDate || "",
                end_date: endDate || "",
                source: source || "",
                category: category || "",
                bank: bank || "",
                min_amount: minAmount|| "",
                max_amount: maxAmount|| "",
            });

            const response = await fetch(`${apiUrl}?${params.toString()}`);
            const data = await response.json();

            updateTable(data.transactions);
            updatePagination(data.total_pages, page);
        }

        function updateTable(transactions) {
            const tableBody = document.getElementById("transactions-table-body");
            tableBody.innerHTML = "";
            transactions.forEach(transaction => {
                const row = document.createElement("tr");
                row.setAttribute("title", `ID: ${transaction.id}`); // Додаємо тултіп із ID
                row.innerHTML = `
                    <td>${new Date(transaction.date).toLocaleDateString()}</td>
                    <td>${transaction.source_name || ""}</td>
                    <td>${transaction.category_name || ""}</td>
                    <td>${transaction.data_source_name || ""}</td>
                    <td>${transaction.amount.toFixed(2)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updatePagination(totalPages, currentPage) {
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement("li");
                li.className = `page-item ${i === currentPage ? "active" : ""}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener("click", (e) => {
                    e.preventDefault();
                    fetchTransactions(i);
                });
                pagination.appendChild(li);
            }
        }

        async function loadFilters() {
    // Load Sources
    const sourceResponse = await fetch(sourcesUrl);
    const sources = await sourceResponse.json();
    const sourceSelect = document.getElementById("source");
    sources.forEach(source => {
        const option = document.createElement("option");
        option.value = source.id;
        option.textContent = source.name;
        sourceSelect.appendChild(option);
    });

    // Load Categories
    const categoryResponse = await fetch(categoriesUrl);
    const categories = await categoryResponse.json();
    const categorySelect = document.getElementById("category");
    categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category.id;
        option.textContent = category.name;
        categorySelect.appendChild(option);
    });

    // Load Banks
    const bankResponse = await fetch(banksUrl);
    const banks = await bankResponse.json();
    const bankSelect = document.getElementById("bank");
    banks.forEach(bank => {
        const option = document.createElement("option");
        option.value = bank.id;
        option.textContent = bank.name;
        bankSelect.appendChild(option);
    });
}

        document.getElementById("filter-form").addEventListener("submit", (e) => {
            e.preventDefault();
            fetchTransactions();
        });

        document.querySelectorAll(".sortable").forEach(th => {
            th.addEventListener("click", () => {
                sortField = th.dataset.sort;
                sortOrder = sortOrder === "asc" ? "desc" : "asc";
                fetchTransactions();
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            loadFilters();
            fetchTransactions();
        });
    </script>

    </script>
     <footer class="bg-light text-center py-3 mt-4">
        <p>&copy; 2025 Finance Tracker</p>
    </footer>
</body>
</html>
